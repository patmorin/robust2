\documentclass{patmorin}
\usepackage{pat}
\usepackage{hyperref}
\usepackage{paralist}
\usepackage[noend]{algorithmic}
\usepackage{datetime2}
\hypersetup{colorlinks=true, linkcolor=linkblue,  anchorcolor=linkblue,
citecolor=linkblue, filecolor=linkblue, menucolor=linkblue,
urlcolor=linkblue, pdfcreator=Me, pdfproducer=Me} 
\setlength{\parskip}{1ex}

\title{\MakeUppercase{Robust Geometric Spanners}}

\author{Prosenjit Bose, Paz Carmi, Vida Dujmovi\'c, 
        Michael van Dyk, and Pat Morin}

\date{\DTMnow}


\newcommand{\note}[2]{{\color{red}[#1:~#2]}}

\DeclareMathOperator{\sz}{size}
\DeclareMathOperator{\rank}{r}
\DeclareMathOperator{\diam}{diam}
\DeclareMathOperator{\dist}{dist}
\DeclareMathOperator{\lbl}{label}

\begin{document}
\maketitle


\begin{abstract}
  For any constants $d\ge 1$, $\epsilon >0$, $t>1$, and any $n$-point
  set $P\subset\R^d$, we show that there is a geometric graph $G=(P,E)$
  having $O(n\log^4 n\log\log n)$ edges with the following property:
  For any $F\subseteq P$, there exists $F^+\supseteq F$, $|F^+| \le
  (1+\epsilon)|F|$ such that, for any pair $p,q\in P\setminus F^+$,
  the graph $G-F$ contains a path from $p$ to $q$ whose (Euclidean)
  length is at most $t$ times the Euclidean distance between $p$ and $q$.
  
  In the terminology of robust spanners (Bose \etal\ 2013) the graph $G$
  is a $(1+\epsilon)k$-robust $t$-spanner of $P$. This construction is
  more sparse than the most recent work (Buchin, Ol\`ah, and Har-Peled 2018)
  which proves the existence of $(1+\epsilon)k$-robust $t$-spanners with
  $n\log^{O(d)} n$ edges.
\end{abstract}

\section{Introduction}

A geometric graph $G=(P,E)$ with vertex set $P\subset\R^d$ is a (geometric)
$t$-spanner of a subset $X\subseteq P$ if, for every pair of distinct vertices
$p,q\in X$, 
\begin{equation}
  \frac{\dist_G(p,q)}{\dist(p,q)} \le t \enspace , \eqlabel{spanning-ratio}
\end{equation}
where $\dist(p,q)$ denotes the Euclidean distance between $p$ and $q$ and
$\dist_G(p,q)$ denotes the Euclidean length of the shortest path between
$v$ and $w$ in $G$, where we use the convention that $\dist_G(p,q)=\infty$
if $v$ and $w$ are in different components of $G$.  Most of the research
on spanners focuses on \emph{sparse} spanners, where the number of edges
in $G$ is linear, or close to linear, in $|P|$.  In addition to having
natural applications to transportation networks, sparse $t$-spanners have
found numerous applications in approximation algorithms and geometric
data structures.
A book \cite{ns07} and handbook chapter \cite{e99} provide
extensive discussions of geometric $t$-spanners and their applications.

For any non-decreasing function $f\colon\N\to\N$, Bose \etal\
\cite{bose.dujmovic.ea:robust} say that a geometric graph $G$ is an
\emph{$f(k)$-robust $t$-spanner} if, for every set $F\subseteq V(G)$,
there exists a set $F^+\supseteq F$ such that $|F^+|\le f(|F|)$ and
the graph $G-F$ is a $t$-spanner of $V(G)\setminus F^+$.  In networking
applications, this definition captures the idea that the number of nodes
harmed by a set of faulty nodes should be bounded by a function of the
number of faulty nodes, independent of the network size $|P|$.

Under this definition, the most robust spanner one could hope for
would be a $k$-robust spanner, but it is straightforward to argue
that, even for one dimensional point sets, the complete graph is the
only $k$-robust spanner.\footnote{Proof: Consider any pair of vertices
$v,w\in V(G)$ that are not adjacent in $G$ and let $F=V\setminus\{v,w\}$.
Then $\|vw\|_{G-F}=\infty$ so $G-F$ is a not a $t$-spanner of $V\setminus
F=V\setminus F^*$ for any $t<\infty$.} The complete graph is not sparse,
and is therefore not suitable for many applications.

A natural second-best option is a $(1+\epsilon)k$-robust spanner with
a near-linear number of edges, for some small constant $\epsilon
>0$.  Buchin \etal\ \cite{buchin.har-peled.ea:spanner} call these
objects $\epsilon$-resilient spanners and prove the existence of
$\epsilon$-resilient spanners with $O(n\log^c n)$ edges, where $c=O(d)$.
In the current paper we reduce the dependence on $d$ by proving the
following theorem:

\begin{thm}\thmlabel{main-i}
  For every constant $d\ge 1$, $\epsilon>0$, $t>1$ and every $n$-point
  set $P\subseteq\R^d$, there exists an $\epsilon$-resilient $t$-spanner
  $G=(P,E)$ with $|E|=O(n\log^4 n\log\log n)$.
\end{thm}

Bose \etal\ \cite{bose.dujmovic.ea:robust} show that, for any constants
$\epsilon>0$ and $t\ge 1$, there exists $1$-dimensional point sets
for which any $(1+\epsilon)k$-robust $t$-spanner has $\Omega(n\log
n)$ edges.  Thus, \thmref{main-i} is within a factor of $O(\log^2
n\log\log n)$ of optimal in any constant dimension.  (Note that in
dimension $d=1$, optimal constructions, having $O(n\log n)$ edges are known
\cite{buchin.har-peled.ea:spanner}.)

The proof of \thmref{main-i} uses several ingredients: The well-separated
pair decomposition \cite{callahan.kosaraju:decomposition}, which
is fairly standard in spanner constructions.  Expander graphs
\cite{hoory.linial.ea:expanders}, that are a natural tool to
achieve robustness. Two less obvious techniques we use are a centroid
decompositions (i.e., hierarchical balanced separators) for binary trees
and an old idea of Willard \cite{willard:maintaining} for file maintenance
(aka, order maintenance) that involves a hierarchical structure whose
smaller substructures have more stringent density requirements than
larger substructures.

These last two ideas represent a significant departure from the work of
Buchin \etal\ \cite{buchin.har-peled.ea:spanner} who 
(among other tools) also use well-separated
pair decompositions and expanders.  However, their constructions, of
which there are two, rely on a reduction to the 1-dimensional problem
and the fact that the paths obtained in the 1-d case have $O(\log n)$ edges.
However, they have very little fine-grained control over the lengths of
these edges, which requires them to construct a $d$-dimensional object
($\theta$-graphs  \cite{keil.gutwin:classes} and locality-preserving orderings \cite{chan.har-peled.ea:on}) in which the relevant
parameter ($\theta$ and $\varsigma$, respectively) is $O(1/\log n)$.  This leads
to $\log^{O(d)} n$ factors in the number of edges in their constructions.

In the remainder of the paper we first review some relevant background material and then present our $\epsilon$-resilient spanner construction.

\section{Background}

In this section we briefly review some existing results used in our
construction.

\subsection{Expanders}

For a graph $G$ and a vertex $x\in V(G)$, define the \emph{neighbourhood}
of $x$ in $G$ as $N_G(x) = \{ y: xy\in E(G)\}$.  For a subset $X\subseteq
V(G)$, $N_G(X)=\bigcup_{x\in X} N_G(x)$.  For a subset $Y\subset
V(G)$, define the \emph{shadow} of $Y$ in $G$ as $S_G(Y) = \{x\in V(G):
N_G(X)\subset Y\}$.

Results like the following lemma, and its proof, are fairly standard
expander constructions (see, for example, the survey by Hoory \etal\
\cite{hoory.linial.ea:expanders}):

\begin{lem}\lemlabel{expander-a}
   For any $k\ge 2$, $\ell\ge 2$, $n\in\N$ and any two sets $A$ and $B$
   each of size $\Theta(n)$, there exists a graph $H=(A\cup B,E)$
   with $|E|=O(n(k\log \ell + \ell\log k))$ such that, for any set $B'\subset B$, $|B'|\ge |B|/\ell$, \[ |N_H(B')| \ge (1-1/k)|A| \enspace . \]
\end{lem}

\begin{proof}
  For simplicity of calculation, assume that $|A|=|B|=n$.  Fix some
  subset $A'\subset A$ of size $|A'|=(1-1/k)|A|$.  Let $a_1,\ldots,a_r$
  be a sequence of $n$ iud random samples from $A$.  Then the probability
  that all of these samples are in $A'$ is
  \[
     \Pr\{\{a_1,\ldots,a_r\}\subset A'\} = (|A'|/|A|)^r = (1-1/k)^r \le e^{-r/k}
  \]
  Let $A$ and $B$ be disjoint $n$-element sets and construct a random
  graph $H$ where each element in $B$ forms an edge with $\Delta$ randomly
  chosen (with replacement) elements in $A$.  For a fixed $A'\subset A$
  with $|A'|=(1-1/k)|A|$ and a fixed $B'\subset B$ with $|B'| = n/\ell$,
  \[
    \Pr\{N_H(B') \subseteq A'\} 
        \le (1-1/k)^{\Delta n/\ell} 
        \le e^{-\frac{\Delta n}{k\ell}}
  \]
  Let $\mathcal{E}$ be the event that there exists $A'\subset A$, $|A'|=(1-1/k)|A|$, $B'\subset B$, $|B'|=n/\ell$ such that $N_H(B')\subseteq A'$.  Then
  \begin{align*}
    \Pr\{\mathcal{E}\} 
        & \le \binom{n}{n/k}\binom{n}{n/\ell}e^{-\frac{\Delta n}{k\ell}} \\
        & \le (ek)^{n/k} (ed)^{n/\ell}e^{-\frac{\Delta n}{k\ell}} \\
        & = \exp((n/k)(1+\ln k) + (n/\ell)(1+\ln(\ell)) - (\Delta n)/(k\ell)) \\
        & < 1
  \end{align*}
  for $\Delta > k(1+\log \ell) + \ell(1+\log k)$.  In particular, there
  must exist at least one graph with $O(n(k\log\ell + \ell\log k))$
  edges that satisifies the conditions of the lemma.
\end{proof}

\lemref{expander-a} can be interpreted informally as saying that very
small subsets of $B$ have neighbourhoods that expand into most of $A$.  
The following lemma expressed in terms
of shrinking shadows of subsets of $A$ is also useful:

\begin{cor}\corlabel{expander-a}
   For any $k\ge 2$, $\tau\ge 1$ and any two sets $A$ and $B$ with $|A|\ge|B|$,
   there exists a graph $H=(A,B,E)$
   with $|E|=O(n(k\log \tau + \tau\log k))$ such that
   for any $A'\subset A$ with $|A'|\le (1-1/k)|A|$, 
   \[ |S_H(A')| \le |A'|/\tau \enspace .\]
\end{cor}




\subsection{Fair-Split Trees and Well-Separated Pair Decompositions}

For two points $p,q\in\R^d$, $\dist(p,q)$, denotes the Euclidean distance
between $p$ and $q$. For two sets $P,Q\subset\R^d$, the distance between
$P$ and $Q$ is $\dist(P,Q)=\max\{\dist(p,q):p\in P, q\in Q\}$.  For a
single point set $P\subset\R^d$, the \emph{diameter} of $P$ is denoted
by $\diam(P)=\max\{\dist(p,q):p,q\in P\}$.

For a rooted binary tree $T$, $L(T)$ denotes the set of leaves in
$T$. We use the convention that, if $T$ consists of a single node $u$,
then $L(T)=\{u\}$. The \emph{size} of $T$, denoted $|T|$ is the number of
leaves $|L(T)|$ of $T$. For a node $u$ in $T$, $T_u$ denotes the subtree
of $T$ rooted at $u$.  We say that $T$ is \emph{full} if each non-leaf
node of $T$ has exactly two children.

A \emph{fair-split tree} $T$ is a full binary tree whose
leaves are points in $\R^d$.  We call $T$ a fair-split tree for $L(T)$.
We let $R(T)$ denote the minimum
axis-aligned bounding box of $L(T)$ and we let $\diam'(T)$ denote the
sum of the side lengths of $R(T)$.  A fair-split tree has the following
\emph{fair-split property}: For any node $w$ with parent $x$, $\diam'(T_w)
\le (1-1/(2d))\diam'(T_x)$.\footnote{Traditionally, fair-split trees
are described as splitting $R(x)$ by bisecting its longest side.
This obviously implies that $\ell(u)\le 1-(1/2d)\ell(x)$.} It is worth
noting that $\diam(L(T))$ and $\diam'(T)$ are bounded by each other:
\[
	\diam(L(T)) \le \diam'(T) \le d\cdot\diam(L(T)) \enspace .
\]	
For any $n$-point set $P\subset\R^d$, a fair-split tree for $P$ can be
computed in $O(dn\log n)$ time \cite{callahan.kosaraju:decomposition}.

For a finite point set $P\subset\R^d$ and any $s>0$,
\emph{well-separated pair decomposition (WSPD)} of $P$ is a set of pairs
$\{(A_i,B_i):i\in\{1,\ldots,m\}\}$ with the following properties:
\begin{enumerate}
  \item For every $i\in\{1,\ldots,m\}$, 
    $\dist(A_i,B_i)\ge s\cdot\max\{\diam(A_i),\diam(B_i)\}$.
  \item For every pair $p,q\in P$ there exists exactly one
    $i\in\{1,\ldots,m\}$ such that $p\in A_i$ and $q\in B_i$, or $q\in A_i$
    and $p\in B_i$.
\end{enumerate}
Well-separated pair decompositions were introduced by Callahan and
Kosaraju \cite{callahan.kosaraju:decomposition}, who construct them
using fair-split trees.

\begin{thm}[Callaghan and Kosaraju 1995]\thmlabel{wspd}
  For any constant $d\ge 1$, any $s\ge 1$ and any $n$-point set
  $P\subset\R^d$ with fair split tree $T=T(P)$, there exists a WSPD
  $\{(A_i,B_i):i\in\{1,\ldots,m\}\}$ of $P$ with size $m\in O(s^d n)$.
  Furthermore, each pair $(A_i,B_i)=(L(T_{a_i}),L(T_{b_i}))$ where $a_i$
  and $b_i$ are nodes of $T$.
\end{thm}
We call the WSPD guaranteed by \thmref{wspd} a WSPD of $P$ \emph{using}
$T$.  In his thesis, Callaghan proves an additional useful result about
well-separated pair decompositions \cite[Section~4.5]{callahan:dealing}:

\begin{lem}[Callaghan 1995]\lemlabel{wspd-ii}
  In the WSPD of \thmref{wspd},
   $\sum_{i=1}^m\min\{|A_i|,|B_i|\} = O(s^d n\log n)$.
\end{lem}


\section{The Construction}

In this section we describe our $\epsilon$-resilient $t$-spanner construction for an $n$-point set $P\subset\R^d$.

\subsection{Exploding into the Root}

Let $T$ be the fair-split tree for an $n$-point set $P$ and consider
the following recursively constructed graph $G_{T}$ whose vertex set
is $P=L(T)$.  If $|T| \le \kappa$ for some constant $\kappa$, then $G_T$
is the complete graph on $L(T)$. For our particular application, we will choose $\kappa\ge 5$.  Note that, for $|T|\ge\kappa\ge 5$, $\rank(T_{u_0}) \ge \floor{\log_{3/2}(5/3)} \ge 1$.

If $|T|>\kappa$, let $u_0$ be a node of $T$ with the property that
$|T|/3\le |T_{u_0}|\le 2|T|/3$.  The existence of $u_0$ (or rather
the edge from $u_0$ to its parent) is a standard result on binary
trees.\footnote{Proof: Begin by setting $v_0$ to the root of $T$ and then repeatedly set $v_{i+1}$ to be the child of $v_i$ whose subtree contains at least half the leaves of $T_{v_i}$.  The smallest index $i$ for which $|T_{v_i}|\le 2|T|/3$ yields the desired node $u_0=v_i$.}   Let $T_1$ be the full binary tree obtained from
$T_u-T_{u_0}$ by contracting an edge incident to the unique non-leaf node
of $T_u-T_{u_0}$ that has only one child.  The graph $G_{T}$ contains
an expander $H_T=(L(T),E_T)$. This expander has parameters $d>1$,
$\alpha, \beta,\zeta,\eta > 0$ and is constructed so that it satisfies
the following properties:
\begin{enumerate}
  \item[(PR1)] For any $X\subset L(T_{u_0})$ with
    $|X|<(1-\beta/\Delta)|T_{u_0}|$, 
    \[ |\{p\in L(T_1): N_{H_T}(p)\subseteq X\}|\le (\alpha/\Delta)|X| \enspace . \]

  \item[(PR2)] For any set $S\subset L(T_{u_0})$ with $|S|\ge
    (\zeta/\Delta)L(T_{u_0})$, \[ |N_{H_T}(S)|\ge (1-\eta/\Delta)|T| \enspace .\]
\end{enumerate}
In our construction, $\Delta=\Theta(\log^2 n)$ and the remaining parameters
are small values that are upper bounded by some function of $\epsilon$. In particular, for any constant $\epsilon >0$, these parameters are also constant.

\begin{clm}
  For any constants $\alpha,\beta,\zeta,\eta>0$, the graph $H_T$ has
  $O(|T|\Delta\log\Delta)$ edges.
\end{clm}

\begin{proof}
  To satisfy Property~(PR1), $H_T$ contains an expander described
  by \corref{expander-a} for the pair $(A=L(T_{u_0}),B=L(T_1))$ with
  parameter $k=\Delta/\beta$ and $\ell=\Delta/\alpha$.  This graph has
  $O(|T|\Delta\log\Delta)$ edges.

  To satisfy Property~(PR2), $H_T$ contains an expander described
  \lemref{expander-a} for the pair $(A=L(T_{u_0}),B=L(T))$ with
  parameters $k=\Delta/\eta$ and $\ell=\Delta/\zeta$. This graph also
  has $O(|T|\Delta\log\Delta)$ edges.
\end{proof}

Finally, we recursively construct $G_{T_{u_0}}$ and $G_{T_1}$ and add the
edges of each of the resulting graphs to $G_{T}$. This concludes the description of the graph $G_T$.

\begin{clm}
  $G_{T}$ has $O((\Delta\log\Delta)|T|\log |T|)$ edges.
\end{clm}

\begin{proof}
  The graph $H_T$ has
  $O(|T|\Delta\log\Delta)$ edges.  The recursive constructions are on two trees $T_{u_0}$
  and $T_1$ where $|T_{u_0}|+|T_1|=|T|$ and $\max\{|T_{u_0}|,T_1\}\le
  2|T|/3$. It follows that the depth of recursion is at most
  $\log_{3/2}|T|$ and each level of recursion contributes a total of
  $O((\Delta\log\Delta)|T|)$ edges for a total of $O((\Delta\log\Delta)|T|\log|T|)$ edges.
\end{proof}

Recall that $\rank(T)=\floor{\log_{3/2} |T|}$ and observe that, in
the preceding construction, $\rank(T_{u_0}) \le \rank(T)-1$ and
$\rank(T_1)\le\rank(T)-1$.  Let $F$ be an arbitrary subset of $P$.  We say
that $T$ is \emph{$F$-dense} if $|L(T)\cap F|\ge (1-\delta\rank(T)/\Delta)|T|$
for some constant $\delta$ to be discussed shortly.  Define the set
$F^+_T$ as follows (here $u_0$ and $T_1$ are defined as above):

\begin{enumerate}
  \item If $T$ is $F$-dense, then $F^+_T\gets L(T)$.
  \item $F^+_T\gets F^+_{T_{u_0}}\cup F^+_{T_1}$.
  \item If $|T_{u_0}|\le (1-\beta/\Delta)|T_{u_0}|$
  \begin{enumerate}
     \item then $F^+_T\gets F^+_T\cup\{p\in L(T_1): N_{H_T}(p)\subseteq
     F^+_{T_{u_0}}\}$.
     \item Otherwise, $|T_{u_0}|> (1-\beta/\Delta)|T_{u_0}|$, and $F^+_T\gets F^+_T\cup L(T_{u_0})$.
  \end{enumerate}
\end{enumerate}

\begin{clm}
   For any constant $\epsilon>0$ there are constants $\alpha,\beta,\zeta,\eta >0$ such that, for any $F\subseteq P$,  $|F^+_T| \le (1+\epsilon\rank(T)/\Delta)|F\cap L(T)|$.
\end{clm}

\begin{proof}
  The proof is by induction on $\rank(T)$. If $|T|=1$, the claim is
  obvious. For $|T|\ge 2$, there are two cases to consider:
  \begin{enumerate}
    \item $T$ is $F$-dense. In this case $F^+_T=L(T)$.  
     Since $T$ if $F$-dense,  $|L(T)\cap F|\ge
     (1-\delta\rank(T)/\Delta)|T|$.  So
     \[
       |F^+_T|=|T|
	  \le \frac{|L(T)\cap F|}{1-\delta\rank(T)/\Delta} 
          \le (1+\epsilon\rank(T)/\Delta)|L(T)\cap F|
     \]
     provided that $\epsilon \ge 1/(1-\delta)-1$ (e.g., $\delta\le \epsilon/2$).

    \item $T$ is not $F$-dense. There are two subcases to consider:
    \begin{enumerate}
       \item $|F^+_{T_{u_0}}| \le (1-\beta/\Delta)|T_{u_0}|$.
         In this case, $F^+_T=F^+_{T_{u_0}}\cup F^+_{T_1}$.
         Recall that
        $\rank(T_{u_0}),\rank(T_1)\le\rank(T)-1$ so, by induction,
         \begin{align}
            |F^+_T| 
              & = |F^+_{T_{u_0}}| + |F^+_{T_{1}}|  \notag \\
              & \le (1+\epsilon\rank(T_{u_0}))/\Delta)|F\cap L(T_{u_0})| 
                    +(1+\epsilon\rank(T_{1}))/\Delta)|F\cap L(T_{1})| \notag \\
              & \le (1+\epsilon(\rank(T)-1))/\Delta)|F\cap L(T_{u_0})| 
                    +(1+\epsilon(\rank(T)-1))/\Delta)|F\cap L(T_{1})|  \notag \\
              & = (1+\epsilon\rank(T)/\Delta)|F\cap L(T)| - (\epsilon/\Delta)|F\cap L(T)| \enspace .
            \eqlabel{inductio}
         \end{align}
         All that remains is to consider the set $F^+_{01}$ of points
         in $L(T_1)$ added to $F^+_T$ in Step~3(a).  In particular,
         we must show that $|F^+_{01}|\le (\epsilon/\Delta)|F\cap L(T)|$. By
         Property~(PR1) of $H_T$,
          \begin{align*}
          |F^+_{01}| 
            & \le (\alpha/\Delta)|F^+_{T_{u_0}}| \\
            & \le (\alpha/\Delta)(1+\epsilon\rank(T_{u_0})/\Delta)|F\cap L(T_{u_0})| \\
            & \le (\alpha/\Delta)(1+\epsilon\rank(T_{u_0})/\Delta)|F\cap L(T)|\\
            & = (\alpha/\Delta+\alpha\epsilon\rank(T_{u_0})/\Delta^2)|F\cap L(T)| \\
            & = (\alpha/\Delta+\alpha\epsilon/\Delta)|F\cap L(T)| 
    	     & \text{(for $\Delta\ge \rank(T)$)} \\
    	& \le (\epsilon/\Delta)|F\cap L(T)| \enspace ,
       \end{align*}
       provided that $\alpha+\alpha\epsilon \le \epsilon$, i.e, 
       $\alpha \le 1/(1+1/\epsilon)$.   

       \item $|F^+_{T_{u_0}}| > (1-\beta/\Delta)|T_{u_0}|$. In this case, $F^+_T=L(T_{u_0}) \cup F^+_{T_1}$ and
       \begin{align*}
          |F^+_T| 
            & = |T_{u_0}| + |F^+_{T_1}| \\
            & \le (1+2\beta/\Delta)|F^+_{T_{u_0}}| + |F^+_{T_1}|
              & \text{(for $\beta\le 1/2$)}\\
            & = |F^+_{T_{u_0}}| + |F^+_{T_1}| + (2\beta/\Delta)|F^+_{T_{u_0}}| \\
            & \le (1+\epsilon\rank(T)/\Delta)|F\cap L(T)| - (\epsilon/\Delta)|F\cap L(T)| + (2\beta/\Delta)|F^+_{T_{u_0}}| 
             & \text{(as in \eqref{inductio})} \\
            & \le (1+\epsilon\rank(T)/\Delta)|F\cap L(T)| - (\epsilon/\Delta)|F\cap L(T)| + (4\beta/\Delta)|F\cap L(T_{u_0})|  \\
              & \qquad \text{(since $|F\cap L(T_{u_0})|\ge |T_{u_0}|/2 \ge |F^+_{T_{u_0}}|$)}\\
            & \le (1+\epsilon\rank(T)/\Delta)|F\cap L(T)| - (\epsilon/\Delta)|F\cap L(T)| + (4\beta/\Delta)|F\cap L(T)| \\
              & \qquad \text{(since $L(T_{u_0})\subseteq L(T)$)} \\
            & \le (1+\epsilon\rank(T)/\Delta)|F\cap L(T)| \enspace ,
       \end{align*}
       provided that $\beta \ge \epsilon/4$. \qedhere
     \end{enumerate}
   \end{enumerate}
\end{proof}


\begin{clm}
  Let $C=4d$ and let $a=\epsilon-3\zeta$.
  For any $F\subset L(T)$ and every point $p\in L(T)\setminus F^+_T$,
  there exists $X\subset L(T)$, $|X|\ge (1-a\rank(T)/\Delta)|T|-|F^+_T\cap
  L(T)|$ such that for every $q\in X$, $G_T-F$ contains a path from $p$
  to $q$ of length at most $C\diam(T)$, for $C\le 4d$.
\end{clm}

\begin{proof}
  The proof is by induction on $|T|$.  If $|T|\le\kappa$, the result is
  trivial since $G_T$ is the complete graph.  For $|T|>\kappa$, there
  are several cases to consider:
  \begin{enumerate}
    \item $|F^+_{T_{u_0}}|\le (1-\beta/\Delta)|T_{u_0}|$. In this case, there are two subcases
    to consider:
    \begin{enumerate}
      \item $p\in L(T_{u_0})$. 
        Since $u_0$ is not the root of $T$, $\diam'(T_{u_0}) \le
        (1-1/2d)\diam'(T)$.  We can therefore apply induction on $T_{u_0}$
        to find a $p$-reachable set $X_0\subseteq L(T_{u_0})$ of size
\begin{align*}
  |X_0| & \ge (1-a\rank(T_{u_0})/\Delta)|T_{u_0}|-F^+_{T_{u_0}} \\
        & \ge (1-a\rank(T_{u_0})/\Delta)|T_{u_0}|-(1-\epsilon\rank(T_{u_0})/\Delta)|T_{u_0}| \\
        & = (\epsilon-a)(\rank(T_{u_0})/\Delta)|T_{u_0}| \\
        & \ge ((\epsilon-a)/\Delta)|T_{u_0}| 
    & \text{(since $\rank(T_{u_0})\ge 1$ when $|T|\ge \kappa \ge 5$)} \\
        & \ge ((\epsilon-a)/(3d))|T| 
        & \text{(since $|T|/3\le |T_{u_0}|$).} 
\end{align*}
      By Property~(PR2) of $H_T$ (with $\zeta = (\epsilon-a)/3$ and $\eta = a\rank(T)$), we can then take $X=N_{H_T}(X_0)\setminus F^+_T$.  Then 
      \begin{align*}
         |X| & \ge (1-\eta/\Delta)|T|-|F^+_T| \\
             & = (1-a\rank(T)/\Delta)|T|-|F^+_T| \\
      \end{align*} and every point $q\in X$ is reachable from $p$ by a path in $G_T-F$ of length at most
        \[ (C(1-(1/2d))+1)\diam'(P) < C\diam'(P) \]
       for $C= 4d$.

      \item $p\in L(T_1)$. Since $p\not\in F^+_T$, $H_T$ contains an
      edge from $p$ to some point $p'\in L(T_{u_1})$.  As described
      in the previous case, there is a $p'$-reachable set $X$ of
      size $(1-a\rank(T)/\Delta)|T|-|F^+_T|$ that is reachable from $p'$
      by paths of length at most $((1-1/2d)C+1)\diam'(P)$.
      The edge $pp'$ has length at most
      $\diam'(T)$. Therefore $X$ is $p$-reachable using
      paths of length at most $((1-1/2d)C+2)\diam'(P)
      = C\diam'(P)$ for $C= 4d$.
    \end{enumerate}

    \item $|F^+_{T_{u_0}}|> (1-\beta/\Delta)|T_{u_0}|$.  In this case,
      $F^+_T= L(T_{u_0})\cup F^+_{T_1}$.  Therefore, $p\in L(T_1)$.
      Now, we apply induction on $T_1$ and obtain a set $X$ that can be
      reached by $p$ in $G_T-F$ with paths of length at most $C\diam'(T_1)\le
      C\diam'(T)$.  All that remains is to show that $X$ is sufficiently
      large, as follows:
  \begin{align*}
    |X| & \ge (1-a\rank(T_1)/\Delta)|T_1|-|F^+_{T_1} \cap L(T_1)| &
       \text{(by the inductive hypothesis)} \\
    & \ge (1-a\rank(T)/\Delta)|T_1|-|F^+_{T_1} \cap L(T_1)| 
     & \text{(since $\rank(T)>\rank(T_1)$)} \\
    & \ge (1-a\rank(T)/\Delta)|T_1|-|F^+_{T} \cap L(T_1)| 
    & \text{(since $F^+_T\supseteq F^+_{T_1}$)} \\
    & > (1-a\rank(T)/\Delta)|T_1|-|F^+_{T} \cap L(T_1)| \\
     & \quad {} + (1-a\rank(T)/\Delta)|T_{u_0}|-|F^+_{T}\cap L(T_{u_0})|
    & \text{(since $|F^+_T \cap L(T_{u_0})|=L(T_{u_0})$} \\
    & = (1-a\rank(T)/\Delta)|T|-|F^+_{T}\cap L(T_1)| - |F^+_T\cap L(T_{u_0})|
    & \text{(since $|T_1|+|T_{u_0}|=|T|$)} \\
%    & = (1-a\rank(T)/\Delta)|T|-|F^+_{T}\cap L(T_1)| - |F^+_T\cap L(T_{u_0})|
%    & \text{(since $F^+_{T_{u_0}}=F^+_T\cap L(T_{u_0})$)} \\
    & = (1-a\rank(T)/\Delta)|T|-|F^+_{T}|  
  \end{align*}
  since $L(T)=L(T_{u_0})\cup L(T_1)$.
  \end{enumerate}
\end{proof}

\subsection{Multiple Scales}
\seclabel{g-p}

For each node $u$ of $T$, define
$\lbl(u)=\floor{\log_{1+\epsilon}|T_u|}$. We say that a node $u$ of $T$
is \emph{special} if $u$ is a leaf or if $\lbl(u)$ is different from both
its children.  If $u$ is special, then $T_u$ is also \emph{special}.
Observe that for every node $w$ of $T$, $T_w$ contains a special
subtree $T_u$ with $|T_u|\ge (1-O(\epsilon))|T_w|$.\footnote{Proof:
Consider the subtree $T_w'$ of $T_w$ induced by all nodes $v$ in $T_w$
such that $\lbl(v)=\lbl(w)$. $T_w'$ is non-empty and therefore contains
at least one leaf $u$. $T_u$ is a special subtree of $T_w$ and $|T_u|\ge
|T_w|/(1+\epsilon)$ so $|T_u|\ge (1-2\epsilon)|T_w|$, for $\epsilon \le
1/2$.}  Let $S(T)$ denote the set of special nodes in $T$.

\begin{lem}\lemlabel{exploder-main}
  For any constant $\epsilon >0$, any $n\in\N$, and any $n$-point
  set $P\subset\R^d$ with fair-split tree $T$, there exists a graph
  $G_P=(P,E)$ with $O(n\log^4 n\log\log n)$ edges such that, for any 
  $F\subseteq
  P$, there exists a superset $F^+_P\supseteq F$ with $|F^+_P|\le
  (1+7\epsilon)|F|$ such that for any node $w$ of $T$ and any point
  $p\in L(T_w)\setminus F^+_P$, there is a special node $u$ in $T_w$
  and a subset $X\subseteq L(T_u)$
  with $|X|\ge \epsilon/4|T_u|$ such that for every $q\in X$, $G_P-F$
  contains a path from $p$ to $q$ of length at most $(C+1)\diam'(T_w)$.
\end{lem}


\begin{proof}
  The graph $G_P$ contains all edges of $G_{T_u}$ for each special node
  $u$ of $T$.  The parameter $\Delta$ in the construction of $G_{T_u}$
  is set to $\Delta=c\log^2 n$ for some sufficiently large constant $c$.
  The total number of edges in all of these graphs is $O(n\log^4
  n\log\log n)$.  

  We say that a node $w$ with parent $x$ in $T$ is \emph{left out of
  node $u$} if $x$ is not special, $T_u$ is the largest special subtree
  of $T_x$ and $u$ is not in $T_w$. Note that each left out node is the
  smaller of the two children of its parent, so that any root to leaf
  path in $T$ contains at most $\log_2 n$ left out nodes.  In other words,
  each point $p\in P$ is left out of at most $\log_2 n$ special nodes.
	
  For a special node $u$, let $w_1,\ldots,w_k$ be the nodes left out of $u$, and  let $K_u=\bigcup_{i=1}^k L(w_i)$.  For each special node $u$ we construct
  an expander graph $H_u$ for the pair
  $(K_u,L(T_u))$. This expander has the property that, for any
  subset $X\subset L(T_u)$ with $|X|\le (1-\epsilon/\log n)|T_u|$, 
  \[ |\{p\in K_u: N_{H_u}(p)\subseteq X\}| \le \epsilon|X|/\log_{1+\epsilon} n \enspace . \] 
  The graph $H_u$ is obtained from \corref{expander-a} with parameters
  $k=\log n/\epsilon$ and $\ell=\log_{1+\epsilon n}/\epsilon$.  Therefore,
  the number of edges in $H_u$ is $O(|K_u|\log n\log\log n)$ edges and
  by summing over all special nodes $u$ this gives a total of $O(n\log^2
  n\log\log n)$ edges.  The graph $G_P$ contains $H_u$ for each special
  node $u$.

  This concludes the description of $G_P$ and the analysis of the number
  of edges in $G_P$. What remains it is to describe and analyze the
  set $F^+_P$.


  Define the set:
  \[  
    F^*_P = \bigcup_{u\in S(T)} F^+_{T_u} \enspace .
  \]
  By choosing $\Delta \ge (\log_{3/2} n)(\log_{1+\epsilon}
  n)$, each special node $u$ of $T$ has $|F^+_{T_u}|\le
  (1+\epsilon/\log_{1+\epsilon} n)|F\cap L(T_u)|$. Therefore, since
  each point in $F$ appears in at most $\log_{1+\epsilon} n$ special
  subtrees, $|F^*_P|\le (1+\epsilon)|F|$.

  We say that a node $w$ of $T$ is $F^*_P$-dense if $|F^*_P \cap L(T_w)| >
  (1-3\epsilon)|T_w|$.  Now, define
  \[  
     F^{**}_P = \cup\{ L(T_w) : \text{$w$ is an $F^+_P$-dense node of $T$} \}
  \]
  For each $p\in F$, the leaf $p$ of $T$ is an $F^+_P$-dense node of
  $T$. Therefore, $F^{**}_P\supseteq F^{*}_P$.  Furthermore,
  \[
      |F^{**}_P| \le |F^*_P|/(1-3\epsilon) \le (1+\epsilon)|F|/(1-3\epsilon) \le (1+5\epsilon)|F|
  \]
  \note{PM}{state upper-bound on $\epsilon$ required for the last inequality.}

  Finally, define 
  \[  F^{***}_P = \bigcup_{u\in S(T)} \{p \in K_u : N_{H_u}(p)\subseteq F^{**}_P \} \]
  What remains is to analyze the size of $|F^{***}_P\setminus F^{**}_P|$.
  For this, we first observe that, if $T_u$ is the largest special
  subtree in $T_x$ and $F^+_{T_u} > (1-\epsilon/\log n)|T_u|$ then
  $L(T_x)\subseteq F^{**}_P$.  This is because
  \[
     |F^{**}_P\cap L(T_x)| 
  \ge  
     |F^+_{T_u}|
  \ge  
     (1-\epsilon/\log_{1+\epsilon} n)|T_u|
  \ge  
     (1-\epsilon/\log_{1+\epsilon} n)(1-2\epsilon)|T_w|
  \ge  
     (1-3\epsilon/\log n)|T_w| \enspace .
  \]
  Therefore a special node $u$ only contributes to $F^{***}_P\setminus
  F^{**}_P$ if $|F^+_{T_u}| \le (1-1/\log n)|T_u|$.  However,
  in this case, the expander property of $H_u$ ensures that $u$
  contributes at most $\epsilon F^+_{T_u}/\log_{1+\epsilon} n\le
  (\epsilon+\epsilon^2)|F\cap L(T_u)|/log_{1+\epsilon} n$ elements to
  $F^{***}_P\setminus F^{**}_P$.  Summing this over all special nodes $u$,
  shows that
  \[
     |F^{***}_P\setminus F^{**}_P| \le (\epsilon+\epsilon^2)|F| \le 2\epsilon|F|
  \]
  In total, this implies that $F^+_P = F^{**}_P\cup F^{***}_P$ has size
  \[ |F^+_P| = |F^{**}_P| + |F^{***}_P\setminus F^{**}_P|\le (1+7\epsilon)|F| .
  \]  
  This concludes the description of $F^+_P$ and the analysis of its
  size.  All that remains is to show that, for any node $w$ and any
  $p\in L(T_w)\setminus F^+_P$, there is a large subset of $L(T_w)$
  that is reachable from $p$ in $G_P-F$ using paths of length at most
  $(C+1)\diam(T_w)$.

  Now, consider any node $w$ of $T$ and any point $p\in L(T_w)\setminus
  F^+_P$.  Let $T_u$ be the largest special subtree in $T_w$.
  There are two cases to consider:
  \begin{enumerate}
    \item $p\in L(T_u)$. In this case, there is a subset $X\subset L(T(u))$
     such that, for each node $q\in X$, $G_{T_u}$ contains a path from
     $p$ to $q$ of length at most $C\diam(T_u)$. Furthermore,
    \begin{align*}
      |X| & \ge (1-a/\log n)|T_u| - F^+_{T_u} \\
          & \ge (1-a/\log n)|T_u| - (1-\epsilon)|T_u| \\
             & \text{since $F^+_{T_u} \subset F^*_P$ and $|F^*_P\cap T_u|\le (1-\epsilon)|T_u|$} \\
         & \ge (\epsilon-a)|T_u| \\ 
         & \ge (\epsilon/2)|T_u| 
           & \text{(for $a \le \epsilon/2$)}\\ 
         & \ge (\epsilon/2)(1-\epsilon)|T_w|  \\
         & \ge (\epsilon/4)(1-\epsilon)|T_w| 
           & \text{(for $\epsilon \le 1/2)$} 
    \end{align*}
    as required.

    \item $p\in L(T_w)\setminus L(T_u)$.  In this case, since $p\not\in
    F^{***}_P$, $G_P-F$ contains an edge $pp'$ with $p'\in L(T_u)\setminus
    F^{+}_{T_u}$.  The edge $pp'$ has length at most $\diam(T_x)$.
    We can now proceed, as in the previous case, from $p'$.
  \end{enumerate}
\end{proof}


\subsection{Navigating the Well-Separated Pairs}

Let $P\subset\R^d$ be an $n$-point set, let $T$ be a fair-split tree for
$P$ and let $W=\{(A_i,B_i):i\in\{1,\ldots,m\}$ be an $s$-well-separated
pair decomposition for $P$ using $T$. We use the convention that,
for each $i\in\{1,\ldots,m\}$, $|A_i|\ge |B_i|$ and $A_i=L(T_{a_i})$
and $B_i=L(T_{b_i})$ where $a_i$ and $b_i$ are nodes of $T$.

Our robust spanner begins with the graph $G_P$ described in the previous
section that is constructed using the fair-split tree $T$.  Next,
we create a new set of well-separated pairs $W'$ as follows:  For each
pair $(A_i,B_i)\in W$, we find the largest special subtree $T_{a_i'}$
of $T_{a_i}$ and the largest special subtree $T_{b_i'}$ of $T_{b_i}$
and add the pair $(A_i',B_i')=(L(T_{a_i'}),L(T_{b_i'}))$ to $W'$.
Although each pair $(A_i',B_i')\in W'$ is well-separated, $W'$ is not
necessarily a WSPD for $P$.  In particular, there are pairs of points
with $p\in A_i\setminus A_i'$, $q\in B_i\setminus B_i'$ that are not
represented in $W'$.

Next, we partition $W'$ into groups $\{W'_u: u\in V(T)\}$ indexed by
the special nodes of $T$ where, for each special node $u\in V(T)$:
\[
	W'_u = \{ (A_i',B_i')\in W' : a_i' = u \}
\]
For each group $G'_u$, define $B'_u=\bigcup\{B_i' : (L(u),B_i')\in W'_u\}$
and let $H'_u$ be an expander graph on the pair $(L(T_u), B'_u)$ with
the following properties:
\begin{enumerate}
  \item[(PR3)] For any $X\subseteq P$ with $|X\cap L(T_u)|\le
  (1-\epsilon/\log n)|T_u|$, define $K_{X,u}=\{p\in B'_u:
  N_{H'_u}\subseteq X\cap L(T_u)\}$.  Then
   \[  |K_{X,u}|\le \epsilon|X|/\log_{1+\epsilon} n \enspace . \]

  \item[(PR4)] For any two sets $X,Y\subset L(T_u)$ with $|X|,|Y|\ge
  \epsilon|T_u|$, $G$ contains at least one edge $xy$ with $x\in X$
  and $y\in Y$.
\end{enumerate}

\begin{clm}\clmlabel{edge-count-iii}
  There exists a graph $H'_u$ that satisifies Properties~(PR3) and (PR4)
  that has $O(|T_u|\log n\log\log n)$ edges.
\end{clm}

\begin{proof}
  To satisfy Property~(PR1), $H'_u$ contains an expander graph for the
  pair $(A_i,B_i)$ described by \corref{expander-a} with parameters
  $k=\ell=\log n/\epsilon$.  This graph has $O(|T_u|\log n\log\log n)$
  edges.

  To satisfy Property~(PR4), $H'_u$ contains an expander graph for the
  pair $(L(T_u),L(T_u))$ described by \lemref{expander-a} with parameters
  $k=\ell=1/\epsilon$.  This graph has $O(|T_u|)$ edges.
\end{proof}

Let $G'_P$ denote the graph obtained by taking all the edges of $H'_u$
for every special node $u$ in $T$.

\begin{clm}
  The graph $G'_P$ has $O(n\log^2 n\log\log n)$ edges.
\end{clm}

\begin{proof}
  By \clmref{edge-count-iii}, each expander graph $H'_u$ has $O(|T_u|\log
  n\log\log n)$ edges.  As usual, the claim then follows by paritition the
  special nodes of $T$ into $O(\log n)$ sets where, for any two nodes $u$
  and $u'$ in the same set, $T_u$ and $T_{u'}$ are disjoint.
\end{proof}

Our final construction $G'_P$ contains the graph $G_P$ described in
\secref{g-p} as well $H'_u$ for every special node $u$ of $T$.

For any set $X\subset P$, we define $K_{X} = \bigcup_{u\in
S(T)} K_{X,u}$.

\begin{clm}\clmlabel{f-prime-size}
  For any $X\subseteq P$, $|K_{X}| \le \epsilon|X|$.
\end{clm}

\begin{proof}
  Property~(PR3) ensures that, for each special node $u$ of $T$,
  $|K_{X,u}|\le \epsilon|F\cap L(T_u)|/\log_{1+\epsilon} n n$.  Again, the
  claim follows by partitioning the special nodes into $O(\log n)$ sets.
\end{proof}

We can now complete the proof of \thmref{main-i}.

\begin{proof}[Proof of \thmref{main-i}]
  The graph $G$ consists of the union of $G_P$ and $G'_P$ where each
  graph is constructed with some value $\epsilon' = \epsilon/c$ for
  some sufficiently large constant $c$.  For any set $F\subset P$, we
  define $F^+ = F^+_P \cup K_{F^+_P}$, where $F^+_P$ is defined in the
  proof of \lemref{exploder-main} and $K_{F^+_P}$ is defined above.  
  That $|F^+| \le (1+\epsilon)|F|$
  follows from \lemref{exploder-main}, which shows that $|F^+_P|\le
  (1+\epsilon/2)|F|$, and \clmref{f-prime-size} which shows that 
  \[
     |K_{F^+_P}|\le (\epsilon/3)|F^+_P|\le (\epsilon/3)(1+\epsilon/2)|F|
     \le \epsilon|F|/2 \enspace ,
  \]
  for any $\epsilon \le 1$.

  Now, consider any two distinct points $p,q\in P\setminus F^+$ and
  let $(A_i,B_i)\in W$ be the pair such that $p\in A_i$ and $q\in B_i$.
  Since $p\not\in F^+_P$, \lemref{exploder-main} implies that there is a
  subset $X_{p}\subseteq A_i'$, with $|X_{p}|\ge (\epsilon/4)|A_i'|$
  such that, for every $x\in X_{p}$, $G-F$ contains a path from $p$
  to $x$ of length at most $(C+1)\diam'(T_{a_i})$.
  
  Now, since $q\not\in K_{F^+_{a_i},a_i}$, $H_{a_i'}$ contains an edge
  $qq'$ with $q'\in A_i\setminus F^+_{a_i}$.  This then defines a set
  $X_{q'}$ analagous to $X_{p}$.  Finally, Property~(PR4), of $H_{a_i'}$
  ensures that there is at least one edge $p'q''$ with $p'\in X_{p}$
  and $q''\in X_{q'}$.  This yields a path from $p$ to $q$ of length at most
  \begin{align*}
    \dist_{G-F}(p,q) & \le \dist_{G-F}(p,p') + \dist(p',q'') + \dist_{G-F}(q'',q') + \dist(q',q) \\
      & \le (2C+3)\diam'(a_i) + \dist(q',q) \\
      & \le (2C+4)\diam'(a_i') + \diam'(b_i) + \dist(p,q) \\
      & \le (1+O(1/s))\dist(p,q) \enspace . 
  \end{align*}
  Choosing $s = c/\epsilon$ for a sufficiently large constant $c$
  completes the proof.
\end{proof}

\section{Discussion}



\bibliographystyle{plain}
\bibliography{robust2}

\end{document}









